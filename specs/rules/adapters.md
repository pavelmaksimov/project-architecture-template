# Адаптеры (Adapters)

Адаптеры — это компоненты инфраструктурного слоя, 
которые инкапсулируют взаимодействие с внешними системами и сервисами.

**Расположение:** `project/infrastructure/adapters/`

**Основные принципы:**
- Изолируют внешние зависимости от бизнес-логики
- Предоставляют удобный интерфейс для работы с внешними сервисами
- Обрабатывают ошибки и специфику внешних API
- Упрощают замену внешних зависимостей на другие, в случае необходимости
- Позволяют подменять реализацию адаптера в тестах на заглушки

## Существующие адаптеры

### auth.py — Адаптер аутентификации

Адаптер для работы с сервисом аутентификации пользователей.
Запросы отслеживаются через prometheus.

**Основной функционал:**
- `check_telegram_user(user_telegram_id: int) -> bool` — проверка существования пользователя Telegram
- `get_users_data() -> dict` — получение данных всех пользователей

### keycloak.py — Адаптер Keycloak

Адаптер для интеграции с Keycloak (система управления идентификацией и доступом).

### voice.py — Адаптер транскрибации и синтеза речи

**⭐ Качественное решение, проверенное на практике**

Адаптер для работы с голосовыми данными: преобразование речи в текст (STT) и текста в речь (TTS).

**Реализация:** `VoiceAdapter` — использует OpenAI API

**Основной функционал:**
- `voice_to_text(voice: bytes | bytearray) -> str` — преобразование голоса в текст
  - Поддерживает указание языка (по умолчанию `ru`)
- `text_to_voice(text: str, instructions: str, voice: str = "alloy") -> io.BytesIO` — синтез речи из текста

**Особенности:**
- Использует retry-механизм с исключением определенных ошибок (BadRequestError, RateLimitError и др.)
- Интегрирован с Prometheus через декораторы `@action_tracking_decorator`
- Оптимизирован для работы с Telegram (поддержка `download_as_bytearray()`)

**Пример использования:**
```python
# Для Telegram
ogg_data = await voice_file.download_as_bytearray()
text = await voice_adapter.voice_to_text(ogg_data)
```

### llm.py — Адаптер для работы с LLM

**Основной функционал:**
- `llm_chat_client() -> ChatOpenAI` — создание клиента LangChain для чата
- `llm_aclient() -> AsyncClient` — создание асинхронного OpenAI клиента

**Особенности:**
- Поддержка Prometheus мониторинга
- Поддержка middleware proxy для работы в контуре

### database.py / adatabase.py — Адаптеры базы данных

Адаптеры для работы с базой данных (синхронный и асинхронный варианты).

**Основной функционал:**
- Управление соединениями с БД
- Выполнение запросов
- Управление транзакциями

TODO: примеры использования сессий и транзакций

### cache.py / acache.py — Адаптеры к Redis

Адаптеры для работы с системой кеширования (синхронный и асинхронный варианты).

**Основной функционал:**
- Сохранение и получение данных из кеша
- Управление TTL (время жизни)
- Инвалидация кеша
