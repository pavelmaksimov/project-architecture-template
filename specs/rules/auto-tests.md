
# Автотесты
- Как запускать тесты написанно в [README.md](../../README.md)
- Фикстуры в [conftest.py](tests/conftest.py).
- Через testconteiners автоматически поднимаются базы данных
- Уровень логирование в тестах настраивается в [pytest.ini](pytest.ini)
- Настроены фикстуры для создания сессий с БД и клиент FastAPI для запросов к эндпоинтам 

Пример теста эндпоинта API [test_endpoints.py](tests/test_domains/test_chat/test_endpoints.py).

##  Антипаттерны в тестах
- большое кол-во assert в тесте это плохо, наилучший вариант, один assert на один тест
- юнит-тесты, это плохо, потому что при рефакторинге приходится изменять тесты, а этим ни кто не хочет заниматься, 
  поэтому будет затруднять рефакторинг. Тестируйте поведение, сверху, через UseCase или эндпоинты (функциональные тесты)
- данные для теста, должны быть внутри теста, несмотря на то, что данные могут дублироваться между тестами
- запрещено использовать unittest.mock.patch, если он вам понадобился, значит реализация спроектирована неверно, 
  перепишите код, следуя принципу dependency inversion, чтобы подменить реализацию объекта в тестируемом коде без патча 

## Фабрики объектов модели ORM в тестах
Позволяют подготавливать окружение для тестирования.
Находятся в [factories.py](tests/factories.py)

Пример использования в [test_ask.py](tests/test_domains/test_chat/test_ask.py)

В тестах используется одна сессия SqlAlchemy с БД, поэтому объекты на самом деле не создаются фабрикой в БД, но
благодаря внутреннему хранилищу ORM, программа видит эти объекты.

Где обычно создают данные для теста? В фикстурах.
Потом их использует и в других тестах.
Чтоб создать немного другие данные, создает еще фикстуру и так проект ими зарастает.

Фабрики позволяют создавать объекты с разными параметрами, что делает их более гибкими.
Одна фабрика для создания объектов с разными настройками.
Полезно, когда вам нужно создавать объекты с разными состояниями в тестах.

Фабрики позволяют изолировать тесты друг от друга, так как каждый тест может создавать свои собственные объекты.

Фабрики упрощают поддержку кода, так как логика создания объектов сосредоточена в одном месте.
Если вам нужно изменить способ создания объекта, вы делаете это только в фабрике, а не в каждом тесте.

Фикстуры в `pytest` могут быть "магическими" — они автоматически подставляются в тесты,
что может затруднить понимание того, что именно происходит.
Фабрики, явно вызываются в коде, улучшая понимание теста.

Фабрики лучше подходят для сложных сценариев,
где нужно создавать объекты с множеством зависимостей или выполнять дополнительные действия при создании.
Фикстуры могут стать громоздкими в таких случаях.

TODO: описать фикстуры, фабрики стабы и моки с примерами использования
TODO: Как подменять ответы HTTP запросов.