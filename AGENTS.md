–§–∞–π–ª –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ specs/rules/*

---

- [üìñ –ö–∞–∫—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é —á–∏—Ç–∞—Ç—å –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è](#-–∫–∞–∫—É—é-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é-—á–∏—Ç–∞—Ç—å-–¥–ª—è-–≤–∞—à–µ–≥–æ-—Å—Ü–µ–Ω–∞—Ä–∏—è)
- [üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [üöÄ –ó–∞–ø—É—Å–∫](#-–∑–∞–ø—É—Å–∫)
- [üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
- [üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
- [üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ GEN AI

–®–∞–±–ª–æ–Ω —Å–æ—Å—Ç–∞–≤–ª–µ–Ω —Å —É—á–µ—Ç–æ–º –æ–ø—ã—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ GEN AI.
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ ~~–±–æ–ª—å –∏ —Å–ª–µ–∑—ã~~ –ø–ª–æ—Ö–∏–µ —Ä–µ—à–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥ –∏ –Ω–µ—É–¥–æ–±–Ω—ã–π –¥–∏–∑–∞–π–Ω.
–ß—Ç–æ–± –Ω–µ –¥–µ–ª–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –æ—à–∏–±–∫–∏, –º—ã —Å–æ–±—Ä–∞–ª–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ.

- üîß –í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–∞–ª–æ–∂–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞
- ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Prometheus –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—É—Ä–∫—Ç—É—Ä–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–æ–Ω—Ç—É—Ä–∞
- ‚ö° –ó–∞–ø—É—Å–∫ FastAPI —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Prometheus –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—É—Ä–∫—Ç—É—Ä–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–æ–Ω—Ç—É—Ä–∞
- üìê –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª—É–π –∏ –∏—Ö –≥—Ä–∞–Ω–∏—Ü—ã (—á—Ç–æ –¥–æ–ª–∂–Ω–æ –∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤ –Ω–∏—Ö –Ω–∞—Ö–æ–¥–∏—Ç—Å—è)
- üîå –ì–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –Ω–∞—à–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ Prometheus (–ö–ª–∏–µ–Ω—Ç—ã-–∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è 
  –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, llm –º–æ–¥–µ–ª–µ–π, OpenAI, keycloak –∏ –¥—Ä—É–≥–∏–µ)
- üõ†Ô∏è –ù–∞–±–æ—Ä –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —É—Ç–∏–ª–∏—Ç, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –¥—Ä—É–≥–æ–≥–æ —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
- üìù –ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- üê≥ –î–æ–∫–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ –±–µ–∑ –±–æ–ª–∏
- üìö –ù–∞–±–æ—Ä –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º
- üé® –í–∞–π–±–∫–æ–¥–∏–Ω–≥ —Å —Ñ–∞–π–ª–æ–º AGENTS.md —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ LLM –∞–≥–µ–Ω—Ç–∞

‚ú® **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —à–∞–±–ª–æ–Ω–∞:**
- üéØ –ü–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
- üîÑ –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π –∫–æ–¥ –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö 
- üöÄ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—É–¥—É—Ç –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –≤ –∫–æ–Ω—Ç—É—Ä–µ

## üìñ –ö–∞–∫—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é —á–∏—Ç–∞—Ç—å –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `specs/rules/` –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:

**‚ú® –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:**
- üîå –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä –∫ –≤–Ω–µ—à–Ω–µ–º—É API ‚Üí [create-adapter.md](specs/rules/create-adapter.md)
- ü§ñ –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Telegram –±–æ—Ç–∞ ‚Üí [telegram-handlers.md](specs/rules/telegram-handlers.md)
- üåê –°–æ–∑–¥–∞—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç ‚Üí [fastapi-and-api-endpoints.md](specs/rules/fastapi-and-api-endpoints.md)
- üóÑÔ∏è –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î ‚Üí [alembic-db-migration.md](specs/rules/alembic-db-migration.md)
- üß™ –°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ-—Ç–µ—Å—Ç ‚Üí [auto-tests.md](specs/rules/auto-tests.md)
- üö® –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—ë –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí [exceptions.md](specs/rules/exceptions.md)
- –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å ORM –º–æ–¥–µ–ª—å ‚Üí [create-orm-model.md](specs/rules/create-orm-model.md)
- üé® –í–∞–π–±–∫–æ–¥–∏–Ω–≥ ‚Üí [development.md](specs/rules/development.md)

**üèõÔ∏è –†–∞–±–æ—Ç–∞ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π:**
- üìê –ü–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–ª–æ–µ–≤ –∏ –≥—Ä–∞–Ω–∏—Ü—ã –º–æ–¥—É–ª–µ–π ‚Üí [layers.md](specs/rules/layers.md)
- –î–æ–º–µ–Ω–Ω–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–∏–ø—ã ‚Üí [tiny-types.md](specs/rules/tiny-types.md)
- üîå –£–∑–Ω–∞—Ç—å –ø—Ä–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–¥–∞–ø—Ç–µ—Ä—ã ‚Üí [adapters.md](specs/rules/adapters.md)
- ‚ö†Ô∏è –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ—Ä–≤—ã –∏ –≤—Ä–µ–º—è, —Å–µ–±–µ –∏ –¥—Ä—É–≥–∏–º ‚Üí [anti-patterns.md](specs/rules/anti-patterns.md)
- üß± –ö–∞–∫–∏–µ –µ—Å—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥—É–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Üí [project-utils.md](specs/rules/project-utils.md)

**‚öôÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- üóÑÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–¥ —á–µ—Ä–µ–∑ ORM, —Å–µ—Å—Å–∏–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí [database-sessions.md](specs/rules/database-sessions.md)
- üîß –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂—É–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Üí [settings-and-environments.md](specs/rules/settings-and-environments.md)
- üìä –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —É—á–∞—Å—Ç–∫–∞ –∫–æ–¥–∞ ‚Üí [monitoring.md](specs/rules/monitoring.md)
- ‚è±Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–µ–Ω–∏–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é ‚Üí [lazy-init-objects.md](specs/rules/lazy-init-objects.md)
- üîç –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä—ã ‚Üí [linters.md](specs/rules/linters.md)
- üì¶ –í—ã–±–æ—Ä –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ ‚Üí [python-libs.md](specs/rules/python-libs.md)

## üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä UV,
[–∫–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å](https://docs.astral.sh/uv/getting-started/installation/#installation-methods).

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
uv sync --all-groups
```

### –ì—Ä—É–ø–ø—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –≥—Ä—É–ø–ø–∞–º –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

**`dev`** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
uv sync --locked --group dev
# –∏–ª–∏ –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏
uv sync --locked --all-extras
```

**`voice`** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ (–≥–æ–ª–æ—Å)
```bash
uv sync --locked --group voice
```

**`telegram`** - Telegram –±–æ—Ç + uvloop + Flask
```bash
uv sync --locked --group telegram
```

**`restapi`** - FastAPI + uvicorn
```bash
uv sync --locked --group restapi
```

**`database`** - Alembic + PostgreSQL + SQLAlchemy
```bash
uv sync --locked --group database
```

–õ–∏–±–æ —á–µ—Ä–µ–∑ pip
```bash
pip install -r requirements.txt -r requirements.dev.txt
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è `.env` –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏,
–ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞–º–∏ –≤ [env.example](env.example).
–û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ [settings.py](project/settings.py).

Linux
```bash
cp .env.example .env
```
Windows
```powershell
Copy-Item .env.example .env
```
Crossplatform
```bash
python3 -c "import shutil; shutil.copy('.env.example', '.env2')"
```

## üöÄ –ó–∞–ø—É—Å–∫

–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `ENV=LOCAL`, –æ–Ω–æ –≤—ã–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –¥—Ä—É–≥–∏–µ –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ
–Ω–µ –Ω—É–∂–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞—Ä–∞–±–æ—Ç–∫–µ.

**‚ö° Fastapi**
```bash
uv run uvicorn project.infrastructure.apps.api:app
```

**ü§ñ Telegram Bot**
```bash
uv run python -m project.infrastructure.apps.bot
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω–∞–ø–∏—Å–∞—Ç—å –∑–∞–ø—É—Å–∫ –≤ –º–æ–¥—É–ª–µ [main.py](project/infrastructure/apps/main.py)
–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:
```bash
python -m project.infrastructure.apps.main
```

TODO: –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –¥–æ–∫–µ—Ä

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```bash
pytest --cov=project tests/
```

–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ [pytest.ini](pytest.ini)

## üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

–°–ª–µ–¥—É–π—Ç–µ [—Å–æ–≥–ª–∞—à–µ–Ω–∏—é](https://www.conventionalcommits.org/en/v1.0.0/) –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–º–∏—Ç–æ–≤.

–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –ª–∏–Ω—Ç–µ—Ä—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ —á–µ—Ä–µ–∑ pre-commit —Ö—É–∫–∏.
–ß—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å pre-commit, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
pre-commit install
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–Ω—Ç–µ—Ä–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [pyproject.toml](pyproject.toml).
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [ruff-tests.toml](tests/ruff-tests.toml).

–ü—Ä–∏ –∫–æ–º–º–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è:
- ‚úÖ ruff check --fix (–ª–∏–Ω—Ç–µ—Ä)
- üé® ruff format (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞)
- üíâ di-linter (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—ä–µ–∫—Ü–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- üèõÔ∏è la-linter (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Å–ª–æ–µ–≤)
- üì¶ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ requirements.txt —á–µ—Ä–µ–∑ UV

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ú–æ–¥—É–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º, —Ç–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –≤ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –≤ DDD, —ç—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ.
–ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –≤–∑–≥–ª—è–Ω—É–≤ –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–æ–Ω—è—Ç—å, –ø—Ä–æ —á—Ç–æ –æ–Ω.
–ò –Ω–µ –Ω–∞–¥–æ –ø—Ä—ã–≥–∞—Ç—å –ø–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º, –∏—Å–∫–∞—Ç—å –º–æ–¥—É–ª–∏ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –æ–¥–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É.

–ì—Ä–∞–Ω–∏—Ü—ã –º–æ–¥—É–ª–µ–π:
- `project/infrastructure/apps/bot.py` - Telegram bot
- `project/infrastructure/apps/flask.py` - –ó–∞–ø—É—Å–∫–∞—Ç–µ—Å—è –Ω–∞ –ø—Ä–æ–¥–µ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å Telegram bot –¥–ª—è 
  —Å–æ–∑–¥–∞–Ω–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ health-check –∏ prometheus
- `project/infrastructure/apps/api.py` - FastAPI app
- `project/infrastructure/apps/main.py` - –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–µ, —Ç–∞–º –∏—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—â–µ–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, 
  –ø–æ—ç—Ç–æ–º—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
- `project/infrastructure/adapters/*` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫ –≤–Ω–µ—à–Ω–∏–º —Å–∏—Å—Ç–µ–º–∞–º (–∞–¥–∞–ø—Ç–µ—Ä—ã, –∫–ª–∏–µ–Ω—Ç—ã)
- `project/infrastructure/utils` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–¥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫
- `project/components/{component}/cli.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ CLI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- `project/components/{component}/endpoints.py` - —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã API
- `project/components/{component}/handlers.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
- `project/components/{component}/models.py` - –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö ORM
- `project/components/{component}/repositories.py` - –õ—é–±–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –¥–∞–Ω–Ω—ã–º
- `project/components/{component}/enums.py` - –ù–∞–±–æ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π
- `project/components/{component}/usecases.py` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (—Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
- `project/components/{component}/service.py` - –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–∫–æ–≥–¥–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –≤  
  usecases.py, –ø–µ—Ä–µ–Ω–æ—Å–∏ —Å—é–¥–∞)
- `project/components/{component}/exceptions` - –∏—Å–∫–ª—é—á–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É
- `project/components/{component}/schemas.py` - —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –∏/–∏–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è pydantic
- `project/components/{component}/ai/{agent_name}/exceptions.py`
- `project/components/{component}/ai/{agent_name}/schemas.py` - —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–∞ (pydantic –º–æ–¥–µ–ª–∏)
- `project/components/{component}/ai/{agent_name}/prompts.py` - llm –ø—Ä–æ–º–ø—Ç—ã, –µ—â–µ –≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∏–∂–µ, –≥–¥–µ –∫–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç 
  –≤ –æ—Ç–¥–µ–ª—å–Ω–æ—Å —Ñ–∞–π–ª–µ, –≤ –æ–±—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ prompts
- `project/components/{component}/ai/{agent_name}/prompts/*.py` - llm –ø—Ä–æ–º–ø—Ç—ã
- `project/components/{component}/ai/{agent_name}/tools/*.py` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ai –∞–≥–µ–Ω—Ç–∞
- `project/components/{component}/ai/{agent_name}/agent.py` - –ª–æ–≥–∏–∫–∞ ai –∞–≥–µ–Ω—Ç–∞
- `project/libs/*` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–¥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- `project/exceptions.py` - –±–∞–∑–æ–≤—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- `project/logger.py` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- `project/settings.py` - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `project/container.py` - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏. –ü–æ—á–µ–º—É –Ω–µ –≤ `project/libs`? –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω –∏–º–ø–æ—Ä—Ç –∏–∑ project.infrastructure.
- `tests/test_*` - –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã
- `tests/conftest.py` - –§–∏–∫—Å—Ç—É—Ä—ã
- `tests/factories.py` - –§–∞–±—Ä–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- `alembic/versions/*` - –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–¥
- `scripts/*` - –°–∫—Ä–∏–ø—Ç—ã
- `specs/rules/*` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏ –∑–∞–ª–æ–∂–µ–Ω–Ω—ã–π –≤ –Ω–µ–º —Å—Ç–∏–ª—å
- `specs/features/*` - –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Ñ–∏—á–∏ –ø—Ä–∏ –≤–∞–π–±–∫–æ–¥–∏–Ω–≥–µ

## –í–∞–π–±–∫–æ–¥–∏–Ω–≥
–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏, 
–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–º –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞, —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É:
```bash
uv run python ./scripts/project_prompt.py # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–Ω—Ñ–∏–≥ ./project-prompt.toml
uv run python ./scripts/project_prompt.py -c my-custom-config.toml
```
–£–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –≤–æ–π–¥—É—Ç –≤ –ø—Ä–æ–º–ø—Ç, –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥ [project-prompt.toml](project-prompt.toml)

- –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —Å–æ–±–ª—é–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏ –Ω–µ —Å–æ–±–ª—é–¥–∞–µ—Ç –∫–∞–∫–∏–µ —Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 
  –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤ ./specs/rules
- –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–¥–µ–ª–∏ –≤–µ—Å—å —Ñ–∞–π–ª [AGENTS.md](./AGENTS.md), –æ–Ω —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤
  ./specs/rules


## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `specs/rules/` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —à–∞–±–ª–æ–Ω–∞:

- [adapters.md](specs/rules/adapters.md) - –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å –∞–¥–∞–ø—Ç–µ—Ä–∞–º–∏ –∏ –æ–±–∑–æ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤
- [alembic-db-migration.md](specs/rules/alembic-db-migration.md) - –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Alembic
- [anti-patterns.md](specs/rules/anti-patterns.md) - –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö —Å–ª–µ–¥—É–µ—Ç –∏–∑–±–µ–≥–∞—Ç—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- [database-sessions.md](specs/rules/database-sessions.md) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (asession, atransaction, current_atransaction)
- [auto-tests.md](specs/rules/auto-tests.md) - –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤
- [create-adapter.md](specs/rules/create-adapter.md) - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∞–¥–∞–ø—Ç–µ—Ä–∞ –∫ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ
- [exceptions.md](specs/rules/exceptions.md) - –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- [fastapi-and-api-endpoints.md](specs/rules/fastapi-and-api-endpoints.md) - Best practices –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- [layers.md](specs/rules/layers.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ —Å–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [lazy-init-objects.md](specs/rules/lazy-init-objects.md) - –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤–º–µ—Å—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [linters.md](specs/rules/linters.md) - –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
- [monitoring.md](specs/rules/monitoring.md) - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ Prometheus
- [project-utils.md](specs/rules/project-utils.md) - –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —É—Ç–∏–ª–∏—Ç
- [python-libs.md](specs/rules/python-libs.md) - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–∏–±–ª–∏–æ—Ç–µ–∫ Python
- [settings-and-environments.md](specs/rules/settings-and-environments.md) - –†–∞–±–æ—Ç–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Settings
- [development.md](specs/rules/development.md) - –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
- [telegram-handlers.md](specs/rules/telegram-handlers.md) - –ü—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram –±–æ—Ç–∞
- [create-orm-model.md](specs/rules/create-orm-model.md) - –ü—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è ORM –º–æ–¥–µ–ª–µ–π
- [tiny-types.md](specs/rules/tiny-types.md) - –î–æ–º–µ–Ω–Ω–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–∏–ø—ã


---

# –ê–¥–∞–ø—Ç–µ—Ä—ã (Adapters)

–ê–¥–∞–ø—Ç–µ—Ä—ã ‚Äî —ç—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ —Å–ª–æ—è, 
–∫–æ—Ç–æ—Ä—ã–µ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `project/infrastructure/adapters/`

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- –ò–∑–æ–ª–∏—Ä—É—é—Ç –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –≤–Ω–µ—à–Ω–∏—Ö API
- –£–ø—Ä–æ—â–∞—é—Ç –∑–∞–º–µ–Ω—É –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ –¥—Ä—É–≥–∏–µ, –≤ —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ü–æ–∑–≤–æ–ª—è—é—Ç –ø–æ–¥–º–µ–Ω—è—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∞–¥–∞–ø—Ç–µ—Ä–∞ –≤ —Ç–µ—Å—Ç–∞—Ö –Ω–∞ –∑–∞–≥–ª—É—à–∫–∏

## –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–¥–∞–ø—Ç–µ—Ä—ã

### auth.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–ó–∞–ø—Ä–æ—Å—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ prometheus.

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `check_telegram_user(user_telegram_id: int) -> bool` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `get_users_data() -> dict` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### keycloak.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä Keycloak

–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Keycloak (—Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –¥–æ—Å—Ç—É–ø–æ–º).

### voice.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∏ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏

**‚≠ê –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ**

–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤ —Ç–µ–∫—Å—Ç (STT) –∏ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å (TTS).

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `VoiceAdapter` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI API

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `voice_to_text(voice: bytes | bytearray) -> str` ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞ –≤ —Ç–µ–∫—Å—Ç
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–∏–µ —è–∑—ã–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `ru`)
- `text_to_voice(text: str, instructions: str, voice: str = "alloy") -> io.BytesIO` ‚Äî —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç retry-–º–µ—Ö–∞–Ω–∏–∑–º —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (BadRequestError, RateLimitError –∏ –¥—Ä.)
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Prometheus —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@action_tracking_decorator`
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ `download_as_bytearray()`)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
# –î–ª—è Telegram
ogg_data = await voice_file.download_as_bytearray()
text = await voice_adapter.voice_to_text(ogg_data)
```

### llm.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `llm_chat_client() -> ChatOpenAI` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ LangChain –¥–ª—è —á–∞—Ç–∞
- `llm_aclient() -> AsyncClient` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ OpenAI –∫–ª–∏–µ–Ω—Ç–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Prometheus –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ middleware proxy –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –∫–æ–Ω—Ç—É—Ä–µ

### database.py / adatabase.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç—ã).

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —Å –ë–î
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

TODO: –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### cache.py / acache.py ‚Äî –ê–¥–∞–ø—Ç–µ—Ä—ã –∫ Redis

–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç—ã).

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏)
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞

---

# –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã
- —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–∞—Ö –∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, redis, postgres
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pickle —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é, —ç—Ç–æ –Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ai –∞–≥–µ–Ω—Ç–∞ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞—Ä—å, –Ω–∞–¥–æ –º–∏–Ω–∏–º—É–º TypedDict, –ª—É—á—à–µ pydantic —Å—Ö–µ–º—É, –æ–Ω–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤, —ç—Ç–æ –Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞, 
  –µ—Å—Ç—å —Ä–∏—Å–∫ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Pandas, Polars –∏ —Ç–æ–º—É –ø–æ–¥–æ–±–Ω–æ–µ.
  –ü–æ –æ–ø—ã—Ç—É –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –∏ –Ω–µ —Ö–æ—á–µ—Ç —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ –∏—Ö –∞–ø–∏, –æ–Ω–æ –ø–ª–æ—Ö–æ —á–∏—Ç–∞–µ—Ç—Å—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–Ω–∞–Ω–∏–µ –∏—Ö –∞–ø–∏.
  –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ —è–∑—ã–∫ SQL –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ —Å–ª–æ–≤–∞—Ä—è–º–∏, –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ 
  TypedDict, dataclass –∏ —Ç.–¥.
- –°–≤—è–∑—å Many-to-Many –≤ ORM –∏ –ë–î —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É. –î–µ–ª–∞–π—Ç–µ —á–µ—Ä–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ –ø–æ–ª—è —Å–ø–∏—Å–∫–∞—Ö, –±–µ–∑ 
  –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ë–î, —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!


### –ò–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
–í–∏–¥–µ–æ –ø—Ä–æ —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É https://www.youtube.com/watch?v=3Z_3yCgVKkM

**–ü–ª–æ—Ö–æ**: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Å–æ–≤ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–π.
```python
class AskUseCase:
    def __init__(self):
        # –ñ–µ—Å—Ç–∫–∞—è —Å–≤—è–∑–∫–∞ —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π, –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞, –º–æ–≥—É—Ç –±—ã—Ç—å –µ—â–µ –º–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
        self.chat = ChatService(...)

    def ask(self, user_id: int, question: str) -> str:
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ç—á–∞.
        repo = DatabaseRepository()  # –ø—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        ...
```

–ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–∞—Ç—á–∏—Ç—å –≤—Å–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ChatService –∏ DatabaseRepository:
```python
from unittes import mock

def test_ask():
    with mock.patch('path.to.ChatService'), \
        mock.patch('path.to.ChatService.create_answer'), \
        mock.patch('path.to.DatabaseRepository'):
        use_case = AskUseCase()
    ...
```

–¢–∞–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–µ–ª–∞—é—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–º.
–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—É—Ç–µ–π, –∏–º–µ–Ω –æ–±—ä–µ–∫—Ç–æ–≤, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ —Ç–µ—Å—Ç—ã —Å –ø–∞—Ç—á–∞–º–∏.
**–õ—É—á—à–µ —Ç–∞–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–Ω–æ—Å–∏—Ç—å —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –º–µ—Ç–æ–¥–æ–≤, –Ω–∏–∂–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä.**

**–•–æ—Ä–æ—à–æ**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (DI Container):
```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from ... import Repository, ChatService

class AskUseCase:
    def __init__(
        self,
        repo: "Repository",
        chat: "ChatService",
    ):
        self.repo = repo
        self.chat = chat

    def ask(self, user_id: int, question: str) -> str:
        ...

class Repository:  # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
    def get(self):
        pass

class ChatService:  # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
    def create_answer(self, user_id, question):
        return "Answer"

class DIContainer:
    def __init__(self, repo=None, chat_service=None):
        self.repo = repo or Repository()
        self._chat = chat_service or ChatService()
        self.ask_use_case = AskUseCase(self.repo, self._chat)

container = DIContainer()
assert container.ask_use_case.ask(user_id=1, question="My question") == "Answer"

class OtherChatService:  # –î—Ä—É–≥–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    def create_answer(self, user_id, question):
        return "Other Answer"

other_container = DIContainer(chat_service=OtherChatService)
assert other_container.ask_use_case.ask(user_id=1, question="My question") == "Other Answer"
```

–¢–∞–∫–æ–π –∫–ª–∞—Å—Å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–µ–∑ –ø–∞—Ç—á–µ–π:
```python
def test_ask_use_case():
    user_id = 1
    question_text = "Test question"
    expected_answer = "Test answer"

    class TestRepo:
        def get(self):
            return user_id

    class TestChatService:
        def create_answer(self, user_id, question):
            return expected_answer

    use_case = AskUseCase(
        repository=TestRepo(),
        chat=TestChatService(),
    )

    result = use_case.ask(user_id, question_text)

    assert result == expected_answer
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞**:
1. –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ç—á–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –Ø–≤–Ω–æ –≤–∏–¥–Ω—ã –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –¥–∞–Ω–Ω—ã–µ
3. –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω–æ–µ API –∫–ª–∞—Å—Å–∞
4. –ü—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ä–∞–±–æ—á–∏–º

---

# –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã
- –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ –≤ [README.md](../../README.md)
- –§–∏–∫—Å—Ç—É—Ä—ã –≤ [conftest.py](tests/conftest.py).
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ testconteiners (–Ω–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤)
- –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ [pytest.ini](pytest.ini)

–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ API [test_endpoints.py](tests/test_domains/test_chat/test_endpoints.py).

##  –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Ç–µ—Å—Ç–∞—Ö
- –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ, –≤–æ —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è –≤–Ω–∏–∫–∞—Ç—å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–∑–±–µ–≥–∞–π—Ç–µ –∏—Ö. –ò–¥–µ–∞–ª—å–Ω–æ, –∫–æ–≥–¥–∞ –≤—Å—ë, —á—Ç–æ 
  –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥–∞–Ω–Ω–æ–º—É —Ç–µ—Å—Ç—É, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä—ã–≥–∞—Ç—å –ø–æ –º–æ–¥—É–ª—è–º, —á—Ç–æ–± –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –æ–Ω 
  —Ä–∞–±–æ—Ç–∞–µ—Ç.
- –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ —Ñ–∏–∫—Å—Ç—É—Ä–∞—Ö –∑–∞—Ç—Ä—É–¥—è–µ—Ç —á—Ç–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –î–∞–Ω–Ω—ã–µ 
  –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏.
- –±–æ–ª—å—à–æ–µ –∫–æ–ª-–≤–æ assert –≤ —Ç–µ—Å—Ç–µ —ç—Ç–æ –ø–ª–æ—Ö–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤ —Ç–∞–º–∫–æ–º —Ç–µ—Å—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –º–Ω–æ–≥–æ –∫–µ–π—Å–æ–≤, –Ω–∞–∏–ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, 
  –≤ –æ–¥–Ω–æ–º —Ç–µ—Å—Ç–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ-—Ç–æ –æ–¥–Ω–æ
- –Ω–µ –ø–∏—à–∏—Ç–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏–∑–º–µ–Ω—è—Ç—å —Ç–µ—Å—Ç—ã, –∞ —ç—Ç–∏–º –Ω–∏ –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç 
  –∑–∞–Ω–∏–º–∞—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É –±—É–¥–µ—Ç –∑–∞—Ç—Ä—É–¥–Ω—è—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–≤–µ—Ä—Ö—É, —á–µ—Ä–µ–∑ UseCase 
  –∏–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã. –ü–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã.
- –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å unittest.mock.patch, –µ—Å–ª–∏ –æ–Ω –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏–ª—Å—è, –∑–Ω–∞—á–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ–≤–µ—Ä–Ω–æ, 
  –ø–µ—Ä–µ–ø–∏—à–∏—Ç–µ –∫–æ–¥, —Å–ª–µ–¥—É—è –ø—Ä–∏–Ω—Ü–∏–ø—É dependency inversion. –ü–æ–¥–º–µ–Ω–∏—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞, –ø–µ—Ä–µ–¥–∞–≤ –º–æ–∫ –æ–±—ä–µ–∫—Ç —Å –¥—Ä—É–≥–∏–º 
  –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º (–∑–∞–≥–ª—É—à–∫—É) –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–ª–∏ —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏.
- –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤ —Ç–µ—Å—Ç–∞—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç—ã

## –ö–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å —Ñ–∞–±—Ä–∏–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ ORM –º–æ–¥–µ–ª–µ–π, –æ–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
–ù–∞—Ö–æ–¥—è—Ç—Å—è –≤ [factories.py](tests/factories.py).
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ [test_use_case.py](../../tests/test_domains/test_chat/test_use_case.py).

–í —Ç–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è SqlAlchemy —Å –ë–î –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ—ç—Ç–æ–º—É –æ–±—ä–µ–∫—Ç—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è 
—Ñ–∞–±—Ä–∏–∫–æ–π –≤ –ë–î, –Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É ORM, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤–∏–¥–∏—Ç —ç—Ç–∏ –æ–±—ä–µ–∫—Ç—ã.

–ì–¥–µ –æ–±—ã—á–Ω–æ —Å–æ–∑–¥–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞? –í —Ñ–∏–∫—Å—Ç—É—Ä–∞—Ö.
–ü–æ—Ç–æ–º –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏ –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö.
–ß—Ç–æ–± —Å–æ–∑–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å–æ–∑–¥–∞–µ—Ç –µ—â–µ —Ñ–∏–∫—Å—Ç—É—Ä—É –∏ —Ç–∞–∫ –ø—Ä–æ–µ–∫—Ç –∏–º–∏ –∑–∞—Ä–∞—Å—Ç–∞–µ—Ç.

–§–∞–±—Ä–∏–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏—Ö –±–æ–ª–µ–µ –≥–∏–±–∫–∏–º–∏.
–û–¥–Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
–ü–æ–ª–µ–∑–Ω–æ, –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –≤ —Ç–µ—Å—Ç–∞—Ö.

–§–∞–±—Ä–∏–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞, —Ç–∞–∫ –∫–∞–∫ –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.

–§–∞–±—Ä–∏–∫–∏ —É–ø—Ä–æ—â–∞—é—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–æ–¥–∞, —Ç–∞–∫ –∫–∞–∫ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞, –≤—ã –¥–µ–ª–∞–µ—Ç–µ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –≤ —Ñ–∞–±—Ä–∏–∫–µ, –∞ –Ω–µ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ.

–§–∏–∫—Å—Ç—É—Ä—ã –≤ `pytest` –º–æ–≥—É—Ç –±—ã—Ç—å "–º–∞–≥–∏—á–µ—Å–∫–∏–º–∏" ‚Äî –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ—Å—Ç—ã,
—á—Ç–æ –º–æ–∂–µ—Ç –∑–∞—Ç—Ä—É–¥–Ω–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
–§–∞–±—Ä–∏–∫–∏, —è–≤–Ω–æ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ, —É–ª—É—á—à–∞—è –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞.

–§–∞–±—Ä–∏–∫–∏ –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤,
–≥–¥–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏.
–§–∏–∫—Å—Ç—É—Ä—ã –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å –≥—Ä–æ–º–æ–∑–¥–∫–∏–º–∏ –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö.

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä –≤ conftest.py

### –§–∏–∫—Å—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**`setup`** (scope="session", autouse=True)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (ENV="AUTOTESTS", —Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

**`init_database`** (scope="session")
- –ü–æ–¥–Ω–∏–º–∞–µ—Ç PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ testcontainers
- –°–æ–∑–¥–∞–µ—Ç —Å—Ö–µ–º—É –ë–î
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç engine –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

**`session`**
- –°–æ–∑–¥–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é SQLAlchemy –¥–ª—è —Ç–µ—Å—Ç–∞
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ (rollback)
- –ë–î –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —á–∏—Å—Ç–æ–π –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_create_user(session):
    # –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—è—Ç—Å—è
    ...
```

**`asession`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è `session`

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
async def test_create_user_async(asession):
    # –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—è—Ç—Å—è
    ...
```

### –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis

**`init_redis`** (scope="session")
- –ü–æ–¥–Ω–∏–º–∞–µ—Ç Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Redis

**`redis`**
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Redis –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –±–∞–∑—É –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ (flushdb)

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_cache(redis):
    # –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ Redis –æ—á–∏—â–∞–µ—Ç—Å—è
    ...
```

**`async_init_redis`** (scope="session")
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**`async_redis`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Redis –∫–ª–∏–µ–Ω—Ç
- –û—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
async def test_cache_async(async_redis):
    # –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ Redis –æ—á–∏—â–∞–µ—Ç—Å—è
    ...
```

### –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API

**`api_client`**
- TestClient –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FastAPI —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç API —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_endpoint(api_client):
    response = api_client.get("/api/users")
    assert response.status_code == 200
    assert response.json() == []
```

### –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

**`httpx_responses`**
- –î–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ (httpx)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É respx

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_external_api(httpx_responses):
    httpx_responses.add(
        "GET",
        "https://api.example.com/data",
        json={"result": "success"},
        status=200
    )
    # –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç—Ç–æ—Ç URL –≤–µ—Ä–Ω—É—Ç mock-–æ—Ç–≤–µ—Ç
```

**`aiohttp_responses`**
- –î–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ (aiohttp)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É aioresponses

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
async def test_external_api_async(aiohttp_responses):
    aiohttp_responses.add(
        "https://api.example.com/data",
        method="GET",
        payload={"result": "success"},
        status=200
    )
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç—Ç–æ—Ç URL –≤–µ—Ä–Ω—É—Ç mock-–æ—Ç–≤–µ—Ç
```

### –§–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak

**`keycloak_client`**
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Keycloak —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Keycloak

**`mock_keycloak`**
- –ú–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã Keycloak –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_keycloak_auth(keycloak_client, mock_keycloak):
    # mock_keycloak –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
    token = keycloak_client.get_token()
    assert token == "test_token"
```

**`keycloak_aclient`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Keycloak

**`mock_async_keycloak`**
- –ú–æ–∫–∏—Ä—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Keycloak

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã

**`project_dir`** (scope="session")
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
- –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ç–µ—Å—Ç–∞—Ö

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
def test_config_file(project_dir):
    config_path = project_dir / "config.yaml"
    assert config_path.exists()
```

---

# –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–∞–ø—Ç–µ—Ä –∫ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å –≤–Ω–µ—à–Ω–∏–º–∏ HTTP API, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Å—ã –∏–∑ [base_client.py](../../project/infrastructure/utils/base_client.py).

–ö–∞–∫ –∑–∞–º–æ–∫–∞—Ç—å http –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—Å—Ç–∞—Ö –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ —Å–ø–µ–∫–µ [auto-tests.md](auto-tests.md).

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **AsyncApi** ‚Äî –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç context manager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (4xx, 5xx)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –º–µ—Ç—Ä–∏–∫–∞–º–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

2. **SyncApi** ‚Äî –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å AsyncApi
   - –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

3. **IClient** ‚Äî Protocol, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–ª–∏–µ–Ω—Ç–∞
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

### –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∞–¥–∞–ø—Ç–µ—Ä–∞

#### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∞–¥–∞–ø—Ç–µ—Ä–∞

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ `project/infrastructure/adapters/`, –Ω–∞–ø—Ä–∏–º–µ—Ä `my_service.py`.

#### –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
from project.exceptions import ApiError, ServerError, ClientError

class MyServiceApiError(ApiError):
    pass

class MyServiceServerError(ServerError):
    pass

class MyServiceClientError(ClientError):
    pass
```

#### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å –∞–¥–∞–ø—Ç–µ—Ä–∞

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä**

```python
from project.infrastructure.utils.base_client import AsyncApi, IClient

class MyServiceClient(IClient):
    class Api(AsyncApi):
        ApiError = MyServiceApiError
        ServerError = MyServiceServerError
        ClientError = MyServiceClientError
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        # ClientSession = MyCustomHttpClient

    def __init__(self, api_key: str):
        self.api_root = "https://api.myservice.com"
        self.api = self.Api(
            self.api_root,
            name_for_monitoring="my_service_api",
            headers={"Authorization": f"Bearer {api_key}"},
            request_settings={"timeout": 30},
        )

    async def get_items(self, resource_id: str) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–∞."""
        return await self.api.call_endpoint(
            f"path/to/resource/{resource_id}",
            method="GET",
            request_settings={"timeout": 3} # example timeout for resource
        )

    async def create_items(self, data: dict) -> dict:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å."""
        return await self.api.call_endpoint(
            "path/to/resource/",
            method="POST",
            json=data,
        )
```

**–í–∞—Ä–∏–∞–Ω—Ç –ë: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä**

```python
from project.infrastructure.utils.base_client import SyncApi

class MyServiceSyncClient:
    class Api(SyncApi):
        ApiError = MyServiceApiError
        ServerError = MyServiceServerError
        ClientError = MyServiceClientError

    def __init__(self, api_key: str):
        self.api_root = "https://api.myservice.com"
        self.api = self.Api(
            self.api_root,
            name_for_monitoring="my_service_api",
            headers={"Authorization": f"Bearer {api_key}"},
        )

    def get_items(self, resource_id: str) -> dict:
        return self.api.call_endpoint(
            f"resources/{resource_id}",
            method="GET",
        )
```

#### –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–±—Ä–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```python
from functools import cache
from project.settings import Settings

@cache
def my_service_client():
    return MyServiceClient(
        api_key=Settings().MY_SERVICE_API_KEY.get_secret_value()
    )
```

#### –®–∞–≥ 5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–∞

```python
from project.infrastructure.adapters.my_service import my_service_client

client = my_service_client()
data = await client.get_items("123")

# –° –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏ (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
async with client.api.Session():
    data1 = await client.get_items("123")
    data2 = await client.get_items("456")
    # –°–µ—Å—Å–∏—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–µ—Ç–æ–¥—ã –≤ Api –∫–ª–∞—Å—Å–µ:

```python
class LimitError(MyServiceClientError):
    pass

class MyServiceClient(IClient):
    class Api(AsyncApi):
        async def response_to_native(self, response):
            # –ö–∞—Å—Ç–æ–º–Ω–∞—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
            return await super().response_to_native(response)
        
        async def error_handling(self, response, response_data):
            # –ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            if response.status == 429:
                raise LimitError("LimitError: Too many requests.")
            
            return await super().error_handling(response, response_data)
```

#### Retry-–º–µ—Ö–∞–Ω–∏–∑–º

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤—å—Ç–µ retry:

```python
from project.libs.retry import retry_on_exception

class MyServiceClient(IClient):
    # ... (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Api –∫–ª–∞—Å—Å–∞)

    @retry_on_exception(
        (LimitError,),
        max_attempts=3,
        backoff=2,
    )
    async def create_item(self, data: dict):
        ...
```

---

# –ü—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö ORM –∏ –º–∏–≥—Ä–∞—Ü–∏–π

- –¢–∞–±–ª–∏—Ü—ã –≤ –±–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–∑—ã–≤–∞—Ç—å –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ.
- –í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è sqlalchemy>=2.0 –≤–µ—Ä—Å–∏–∏.
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Postgres.
- –ü–æ—Å–ª–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ alembic.
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ORM –º–æ–¥–µ–ª–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ –≤
  [factories.py](../../tests/factories.py)
- Declarative Mapping 2.0 (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Mapped` –∏ `mapped_column`)
- –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–∏—Ç–∏–≤—ã (`int`, `str`) –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π —Å—É—â–Ω–æ—Å—Ç–µ–π

##  1. –ú–∏–∫—Å–∏–Ω—ã –º–æ–¥–µ–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ:
```py
import datetime as dt

from sqlalchemy import func, MetaData
from sqlalchemy.orm import (
    Mapped,
    mapped_column,
    declarative_base,
)

public_schema = MetaData()
Base = declarative_base(metadata=public_schema)


class TimeMixin:
    created_at: Mapped[dt.datetime] = mapped_column(nullable=False, server_default=func.now())
    updated_at: Mapped[dt.datetime] = mapped_column(nullable=False, server_default=func.now(), onupdate=func.now())

```

## 2. –î–æ–º–µ–Ω–Ω–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–∏–ø—ã (Domain Types)
–î–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞, –≤–º–µ—Å—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ (`int`, `str`) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏.

- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –¢–∏–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `typing.NewType`, –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è –∑–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `typing.Annotated`.
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í—Å–µ —Ç–∏–ø—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ñ–∞–π–ª–µ `project/datatypes.py`.

–ü—Ä–∏–º–µ—Ä (`project/datatypes.py`):
```python
import typing as t

UserIdT = t.NewType("UserIdT", t.Annotated[int, "User ID"])
OrderIdT = t.NewType("OrderIdT", t.Annotated[int, "Order ID"])
ProductNameT = t.NewType("ProductNameT", t.Annotated[str, "Product Name"])
```

## 3. –†–∞–±–æ—Ç–∞ —Å Enum (–ù–∞—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã Postgres)
–í PostgreSQL —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–µ ENUM —Ç–∏–ø—ã.

1.  Python –∫–ª–∞—Å—Å: –ù–∞—Å–ª–µ–¥—É–π—Ç–µ—Å—å –æ—Ç `str` –∏ `enum.Enum`.
2.  SQLAlchemy –ø–æ–ª–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sqlalchemy.Enum(..., name="...")`.
3.  –í–∞–∂–Ω–æ: –ü–∞—Ä–∞–º–µ—Ç—Ä `name` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–ø–∞ –≤ –ë–î.

```python
class UserRole(str, enum.Enum):
    ADMIN = "admin"
    USER = "user"

# –í –º–æ–¥–µ–ª–∏:
role: Mapped[UserRole] = mapped_column(Enum(UserRole, name="user_role_enum"))
```

## 4. –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏ (Primary Keys)
### 4.1. –¢–∏–ø—ã –∏ BigInteger
- –î–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–∞ (`Mapped[...]`) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ–º–µ–Ω–Ω—ã–π —Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserIdT`), –∞ –Ω–µ `int`.
- –î–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–ª–æ–Ω–∫–∏ (`mapped_column(...)`) –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ `BigInteger` (–∞–Ω–∞–ª–æ–≥ `BIGSERIAL`).

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
id: Mapped[UserIdT] = mapped_column(BigInteger, primary_key=True)
```

### 4.2. –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∫–ª—é—á–∏
–ï—Å–ª–∏ –∫–ª—é—á —Å–æ—Å—Ç–∞–≤–Ω–æ–π, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ `primary_key=True` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è.

## 5. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Many-to-Many (–ß–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤—ã)
–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Ç–∏–≤–Ω—ã–π —Ç–∏–ø `ARRAY` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.

- –¢–∏–ø –∫–æ–ª–æ–Ω–∫–∏: `mapped_column(ARRAY(BigInteger))`.
- –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è: `Mapped[list[DomainIdT]]`.

```python
# –ü—Ä–∏–º–µ—Ä: –°—Ç–∞—Ç—å—è —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ ID —Ç–µ–≥–æ–≤
tag_ids: Mapped[list[TagIdT]] = mapped_column(ARRAY(BigInteger), default=list)
```

## 6. –ò–Ω–¥–µ–∫—Å—ã
- –ü—Ä–æ—Å—Ç—ã–µ: `index=True` –≤–Ω—É—Ç—Ä–∏ `mapped_column`.
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ: `Index("name", "col1", "col2")` –≤ `__table_args__`.
- –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å: –î–ª—è –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π.

## 7. –ü—Ä–∏–º–µ—Ä (Golden Sample)
–ì–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ–¥, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è —ç—Ç–æ–º—É —à–∞–±–ª–æ–Ω—É. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤ –∏–∑ `project.datatypes`.

```python
import enum
import typing as t
from datetime import datetime

from sqlalchemy import (
    BigInteger, 
    String, 
    ForeignKey, 
    func, 
    Index, 
    Enum
)
from sqlalchemy.dialects.postgresql import ARRAY
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column

# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ project/datatypes.py
# –ù–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –∏—Ö:
# from project.datatypes import ProductIdT, ProductNameT, OrderIdT, OrderStatusT

# --- MOCK DATATYPES (–¥–ª—è –ø—Ä–∏–º–µ—Ä–∞) ---
ProductIdT = t.NewType("ProductIdT", t.Annotated[int, "Product ID"])
ProductNameT = t.NewType("ProductNameT", t.Annotated[str, "Product Name"])
OrderIdT = t.NewType("OrderIdT", t.Annotated[int, "Order ID"])
# ------------------------------------

# 1. Base
class Base(DeclarativeBase):
    pass

# 2. Enums
class OrderStatus(str, enum.Enum):
    CREATED = "created"
    PROCESSING = "processing"
    COMPLETED = "completed"

# 3. Models
class Product(Base):
    __tablename__ = "products"

    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ + BigInteger
    id: Mapped[ProductIdT] = mapped_column(BigInteger, primary_key=True)
    
    # –î–æ–º–µ–Ω–Ω—ã–π —Ç–∏–ø –¥–ª—è —Å—Ç—Ä–æ–∫–∏
    name: Mapped[ProductNameT] = mapped_column(String(150), index=True)
    
    price: Mapped[int] = mapped_column(BigInteger) # –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –º–æ–∂–Ω–æ int
    
    # Many-to-Many via Array of IDs
    related_product_ids: Mapped[list[ProductIdT]] = mapped_column(ARRAY(BigInteger), default=list)

class Order(Base):
    __tablename__ = "orders"

    id: Mapped[OrderIdT] = mapped_column(BigInteger, primary_key=True)
    
    # Native Postgres Enum
    status: Mapped[OrderStatus] = mapped_column(
        Enum(OrderStatus, name="order_status_enum"),
        default=OrderStatus.CREATED,
        index=True
    )
    
    created_at: Mapped[datetime] = mapped_column(server_default=func.now())

class OrderLog(Base):
    __tablename__ = "order_logs"

    # Composite Primary Key Example with Domain Types
    order_id: Mapped[OrderIdT] = mapped_column(
        ForeignKey("orders.id", ondelete="CASCADE"), 
        primary_key=True
    )
    log_index: Mapped[int] = mapped_column(BigInteger, primary_key=True)
    
    message: Mapped[str] = mapped_column(String)
```

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Alembic
–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [Alembic](https://alembic.sqlalchemy.org/) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

#### –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –º–æ–¥–µ–ª—è—Ö
alembic revision --autogenerate -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
```

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1
```

–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ç–æ–∫ –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –≤ –≤–∞—à–∏—Ö –≤–µ—Ç–∫–∞—Ö –æ–Ω–∏ —É—à–ª–∏ –¥–∞–ª—å—à–µ, —á–µ–º –Ω–∞ –≤–µ—Ç–∫–µ, –≤ –∫–æ—Ç–æ—Ä—É—é 
–≤—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å.

---

# –°–æ–∑–¥–∞–Ω–∏–µ CacheRepository

CacheRepository ‚Äî —ç—Ç–æ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–µ—à–∞. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π TTL.

–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `project/components/{component}/repositories.py`

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞

### key_template
–¢–∏–ø: `t.ClassVar[str]`

–®–∞–±–ª–æ–Ω –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π –∫–µ—à–∞. –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `{}` –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ
key_template = "user:{}"

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
key_template = "user"  # –ù–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞
```

### ttl
–¢–∏–ø: `t.ClassVar[timedelta]`

–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ –∫–µ—à–µ:

```python
# –ü—Ä–∏–º–µ—Ä—ã TTL
ttl = timedelta(days=7)           # 7 –¥–Ω–µ–π
ttl = timedelta(seconds=60)       # 60 —Å–µ–∫—É–Ω–¥
```

## –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞

### client
–¢–∏–ø: `t.ClassVar[redis_client]`

–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis. –£–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –±–∞–∑–æ–≤–æ–º –∫–ª–∞—Å—Å–µ:

```python
from project.infrastructure.adapters.acache import redis_client

class CacheRepository:
    client = redis_client
```

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `cls.client()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤.

## –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (Pydantic)

–î–ª—è –¥–∞–Ω–Ω—ã—Ö –∫–µ—à–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Pydantic —Å—Ö–µ–º—ã:

```python
from pydantic import BaseModel

class UserCacheSchema(BaseModel):
    id: int
    name: str
    email: str
    created_at: datetime

    class Config:
        from_attributes = True
```

## –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞
–ò–º—è –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `CacheRepository` –∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç `CacheRepository`:

```python
class UserCacheRepository(CacheRepository):
    ...

class ProductCacheRepository(CacheRepository):
    ...
```

### 2. –î–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –∫–ª—é—á–µ–π
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏–∑ `project/datatypes.py` –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π:

```python
from project.datatypes import UserIdT, ProductIdT

async def save(cls, user_id: UserIdT, data: "BaseModel"): ...
async def get(cls, product_id: ProductIdT): ...
```

### 3. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `orjson` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `data.model_dump(exclude_unset=True)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è
- –î–ª—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `orjson.loads()`

–ü–æ–ª–Ω—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –≤ [repositories.py](../../project/components/user/repositories.py):
```python
class UserCacheRepository(CacheRepository):
    key_template = "user:{}"
    ttl = timedelta(days=7)

    @classmethod
    async def save(cls, user_id: UserIdT, data: "BaseModel"):
        async with redis_atransaction() as tr:
            content = orjson.dumps(data.model_dump(exclude_unset=True))
            tr.set(cls.key_template.format(user_id), content, ex=cls.ttl)

    @classmethod
    async def get(cls, user_id: UserIdT):
        content = await cls.client().get(cls.key_template.format(user_id))
        if content:
            data = orjson.loads(content)
            return UserCacheSchema(**data)

        return content

    @classmethod
    async def delete(cls, user_id: UserIdT):
        async with redis_atransaction() as tr:
            tr.delete(cls.key_template.format(user_id))
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–µ—à–µ–º:

```python
class UserCacheRepository(CacheRepository):
    ...

    @classmethod
    async def exists(cls, user_id: UserIdT) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ –≤ –∫–µ—à–µ."""
        return await cls.client().exists(cls.key_template.format(user_id)) > 0
```

---

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Database Sessions)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `project/infrastructure/adapters/adatabase.py`

### asession() ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

**–î–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é.

```python
# –ü—Ä–æ—Å—Ç–æ–µ —á—Ç–µ–Ω–∏–µ
async with asession() as session:
    result = await session.execute(select(User).where(User.id == user_id))
    user = resulscalar_one_or_none()

# –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ —Å–µ—Å—Å–∏—é
async with asession() as session1:
    async with asession() as session2:
        # session1 === session2
```

‚ö†Ô∏è **–ù–µ —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é**. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `atransaction()`.

---

### atransaction() ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

**–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**. –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º commit/rollback.

```python
# –ü—Ä–æ—Å—Ç–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
async with atransaction() as session:
    user = User(name="John")
    session.add(user)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit

# –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç SavePoint
async with atransaction() as session:
    user = User(name="John")
    session.add(user)
    
    try:
        async with atransaction() as s:
            # –°–æ–∑–¥–∞–µ—Ç—Å—è SavePoint
            post = Post(title="Test", user=user)
            s.add(post)
            raise ValueError()
    except ValueError:
        pass  # SavePoint –æ—Ç–∫–∞—Ç–∏–ª—Å—è, –Ω–æ user —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°–µ—Å—Å–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí —Å–æ–∑–¥–∞–µ—Ç `begin_nested()` (SavePoint)
- –°–µ—Å—Å–∏—è –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí —Å–æ–∑–¥–∞–µ—Ç `begin()`
- –ù–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

---

### current_atransaction() ‚Äî –¢–µ–∫—É—â–∞—è –∏–ª–∏ –Ω–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

**–î–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é.

```python
async def reusable_operation():
    async with current_atransaction() as session:
        # –†–∞–±–æ—Ç–∞–µ—Ç –∏ –≤–Ω—É—Ç—Ä–∏, –∏ –≤–Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        user = User(name="John")
        session.add(user)

# –í–∞—Ä–∏–∞–Ω—Ç 1: —Å–æ–∑–¥–∞—Å—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
await reusable_operation()

# –í–∞—Ä–∏–∞–Ω—Ç 2: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
async with atransaction():
    await reusable_operation()
```

**–û—Ç–ª–∏—á–∏–µ –æ—Ç atransaction():**
- `atransaction()` ‚Äî –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (SavePoint)
- `current_atransaction()` ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –±–µ–∑ SavePoint

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –∫–ª–∞—Å—Å–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `project/components/base/repositories.py`

### ORMRepository ‚Äî –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è, –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤ –∫–ª–∞—Å—Å–æ–≤,
–≤–æ –≤–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–µ—Ä—Ç–∫–∏ —á–µ—Ä–µ–∑ project.container.AllRepositories

–í–Ω–µ –∫–ª–∞—Å—Å–æ–≤, –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ –Ω–∞–¥–æ!

```python
class ORMRepository(Generic[T]):
    @classmethod
    @contextmanager
    def get_session(cls):
        with Session() as session:
            yield session

    @classmethod
    @contextmanager
    def get_transaction(cls):
        with transaction() as session:
            yield session

    @classmethod
    @contextmanager
    def get_current_transaction(cls):
        with current_transaction() as session:
            yield session


class ORMModelRepository(ORMRepository[T]):
    # –ù–∞—Å–ª–µ–¥—É–µ—Ç –º–µ—Ç–æ–¥—ã –æ—Ç ORMRepository.
    ...
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

### AllRepositories ‚Äî –¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `project/container.py`

–ö–ª–∞—Å—Å `AllRepositories` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º.
–ï–≥–æ –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∫–æ–≥–¥–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
–Ω—É–∂–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–æ–≤ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

```python
class AllRepositories:
    def __init__(self):
        self.user = UserRepository()
        ...

    @classmethod
    @contextmanager
    def transaction(cls) -> Generator["ORMSession", Any, None]:
        with transaction() as session:
            yield session

    @classmethod
    @contextmanager
    def current_transaction(cls) -> Generator["ORMSession", Any, None]:
        with current_transaction() as session:
            yield session
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from project.container import Repositories

# –ß–µ—Ä–µ–∑ —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
user = Repositories().user.get(user_id)

# –ß–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
with Repositories.transaction() as session:
    Repositories.user.save(user_data)
    Repositories.employee.save(employee_data)

# –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
with Repositories.current_transaction() as session:
    ... 
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö

–í `tests/conftespy` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ñ–∏–∫—Å—Ç—É—Ä—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º rollback:

### –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞ session

```python
@pytesfixture
def session(init_database):
    with database.Session() as session:
        with session.begin() as t:
            with session.begin_nested():
                yield session
                # –î–∞–Ω–Ω—ã–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
            rollback()
    
    database.engine_factory.cache_clear()
    database.scoped_session_factory.cache_clear()
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞ asession

```python
@pytest_asyncio.fixture
async def asession(init_database):
    async with adatabase.asession() as asession:
        async with asession.begin() as t:
            async with asession.begin_nested():
                yield asession
                # –î–∞–Ω–Ω—ã–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
            await rollback()
    
    adatabase.aengine_factory.cache_clear()
    adatabase.async_sessionmaker_factory.cache_clear()
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è —á–µ—Ä–µ–∑ `adatabase.asession()`
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —á–µ—Ä–µ–∑ `begin()`
3. –°–æ–∑–¥–∞–µ—Ç—Å—è –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (SavePoint) —á–µ—Ä–µ–∑ `begin_nested()`
4. –¢–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ SavePoint
5. –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –¥–∞–Ω–Ω—ã–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `rollback()`
6. –û—á–∏—â–∞—é—Ç—Å—è –∫–µ—à–∏ —Ñ–∞–±—Ä–∏–∫ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç—É—é –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã.

---

- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∫–æ–¥–µ, –∏—Ö —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ ./specs
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–∞–∫–µ—Ç–æ–≤
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–∞–∫–µ—Ç __future__

---

# Exceptions
–°–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å–ª–µ–¥—É–π—Ç–µ –æ—Ç `project.exceptions.AppError`

---

## API Best practices
uvicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å —Ü–∏–∫–ª–æ–º uvloop
```bash
uvicorn project.presentation.api:app -host 0.0.0.0 --loop uvloop
```

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è –≤ `project.components.{name}.endpoints`.

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤ API
–õ—É—á—à–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è.
–¢–æ–≥–¥–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ —Ä—É—á–∫–∏, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—É—é —Å—Ö–µ–º—É –¥–ª—è —ç—Ç–æ–≥–æ `project.components.base.schemas.ApiResponse`.
–ï—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ response_model, –≤ swagger –ø–æ—è–≤–∏—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≤—ã–≤–æ–¥—É.
–ù–æ –≤ —Å–ª—É—á–∞–µ —Ç—è–∂–µ–ª—ã—Ö –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–∞—Ç–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏,
–ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ `pydantic`, —ç—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç 2.5 —Ä–∞–∑–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º dict/dataclass.

```python
from project.components.base.schemas import ApiResponseSchema


@app.get("/my", response_model=ApiResponseSchema[list[int]])
async def my_resource():
    return {"data": [1, 2]}
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É –≤ API
–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –∑–∞—à–∏—Ç–∞ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.
```python
def auth_by_token(auth_token: str = Header(alias="Api-Token")):
    if auth_token != Settings().API_TOKEN:
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid Token")
    return auth_token

app = FastAPI(..., dependencies=[Depends(auth_by_token)])
```

### –ë—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ JSON
 `ORJSONResponse` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞–∫–µ—Ç `orjson` –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ `RUST`, –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π.
–ú–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Å–∞–º–æ–π —Ä—É—á–∫–µ —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç `response_class`.

```python
from fastapi.responses import ORJSONResponse

@app.get("/health", response_class=ORJSONResponse)
async def health_check():
    return {}
```

### –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ URL –ø—É—Ç—å `/user/v1/list`
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä—É—á–µ–∫ –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä—É—á–∫–∏ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π, –∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–º–µ—á–∞–µ–º `deprecated`.
```
@app.get("/user/v1/list", deprecated=True)
```

### –û—à–∏–±–∫–∏ HTTP
–ù–µ –Ω—É–∂–Ω–æ —Ç–∞—â–∏—Ç—å `fastapi.exceptions.HTTPException` –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –º–æ–¥—É–ª—è—Ö `endpoints.py`.

---

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã

TODO: –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å

–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å —Å–ª–æ–∏—Å—Ç—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä - –æ—Ç–¥–µ–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞.

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - —ç—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, ORM, –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–º—É —Å–µ—Ä–≤–∏—Å—É, —à–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–∫–∞
—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ —Ç.–¥.

–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –±—ã—Ç—å –ø–æ–¥–∞–ª—å—à–µ –æ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏–Ω–≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π,
–Ω–∏–∂–µ–ª–µ–∂–∞—â–∏–µ —Å–ª–æ–∏ –Ω–µ –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –≤—ã—à–µ—Å—Ç–æ—è—â–∏—Ö.

–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤ Python —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ —Å–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–æ–≤
–∏–∑ —Å–ª–æ—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞.
–ß—Ç–æ–±—ã –æ–±–æ–∑–Ω–∞—á–∏—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑ —Å–ª–æ—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö —Ç–∏–ø–æ–≤, –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—è –∏—Ö,
–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞—Å–ª–µ–¥—É—è—Å—å –æ—Ç –∫–ª–∞—Å—Å–∞ `Protocol`.
–ü—Ä–∏–º–µ—Ä –≤ [interfaces.py](project/components/chat/interfaces.py)

–ò–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, —É–ø—Ä–æ—â–∞–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç—É—Ç [test_ask.py](tests/test_domains/test_chat/test_ask.py)

–ü—Ä–∏–º–µ—Ä, –∫–∞–∫ –Ω–∞–¥–æ –ø–∏—Å–∞—Ç—å –º–æ–¥—É–ª–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–æ–º–µ–Ω–∞ [chat](project/components/chat)

## –°–ª–æ–∏

–°—á–∏—Ç–∞—é, —á—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ UseCase, Service, Repository
–º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
–í–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–æ –º–µ—Ä–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.
–ü–æ—ç—Ç–æ–º—É –æ–≥—Ä–∞–Ω–∏—á–∏–º—Å—è –æ–ø–∏—Å–∞–Ω–∏–µ–º —ç—Ç–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.

**UseCase** - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–∏. –ü—Ä–∏–º–µ—Ä [use_cases.py](project/components/chat/use_cases.py).
–°–ª–æ–π, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞ –∑–∞–ø—É—Å–∫–∞—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.
–ó–¥–µ—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã, –ª–∏–º–∏—Ç–æ–≤ –∏ —Ç.–¥.
–ü–æ—ç—Ç–æ–º—É –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã –∏ –ø–æ–¥–¥–æ–º–µ–Ω—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UseCase`.
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `Service`-–∞—Ö.
–í `UseCase` –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ `Service`-–∞—Ö –≤ –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–∞—Ö –∏ –ø–æ–¥–¥–æ–º–µ–Ω–∞—Ö.
–ò–º—è —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–æ–ª–∂–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—é.
–û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ `UseCase` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–º (–º–∞–ª–æ —Å—Ç—Ä–æ–∫) –∏ –ø–æ–Ω—è—Ç–Ω—ã–º –¥–ª—è —á—Ç–µ–Ω–∏—è.
–°–∞–º –∫–æ–¥, –Ω–µ–π–º–∏–Ω–≥ –∫–ª–∞—Å—Å–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤ –¥–æ–ª–∂–µ–Ω –æ–ø–∏—Å—ã–≤–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö –±–∏–∑–Ω–µ—Å–∞ -
–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –∫–≤–æ—Ç—É, –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å.
–í–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —ç—Ç–æ–º —Å–ª–æ–µ,
–Ω–æ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–π) –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –º–æ–¥—É–ª—å `validation.py`

`UseCase` - —ç—Ç–æ –æ–±—ä–µ–∫—Ç –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

**Service** - —Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞. –ü—Ä–∏–º–µ—Ä [service.py](project/components/chat/service.py)
–ú–æ–∂–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –≤ —Å–µ–±–µ —Ä–∞–±–æ—Ç—É –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–º–µ–Ω–æ–≤.\
–û–±—ä–µ–∫—Ç –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

**Repository** - –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –æ—Ç ORM. –ü—Ä–∏–º–µ—Ä [repositories.py]
(project/components/chat/repositories.py)\
–û–±—ä–µ–∫—Ç –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

- –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏–∑–æ–ª–∏—Ä—É–π—Ç–µ –≤ –∫–ª–∞—Å—Å–∞—Ö Repository, –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–¥ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç 
  —á–∏—Ç–∞—Ç—å –∏ –ø–æ–Ω–∏–º–∞—Ç—å —Å–∞–º—É –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É. –ò—â–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –º–æ–¥—É–ª—è—Ö [repositories.py](project/components/user/repositories.py)
- –ï—Å—Ç—å generic –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –±–∞–∑–æ–≤—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏, –Ω–∞—Å–ª–µ–¥—É–π—Ç–µ –≤–∞—à–∏ Repository –æ—Ç –Ω–µ–≥–æ, –ø—Ä–∏–º–µ—Ä –≤ [repositories.py](project/components/user/repositories.py)

```python
# –ö–æ–≥–¥–∞ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –ª—É—á—à–µ —É–≤–∏–¥–µ—Ç—å —Ç–∞–∫–æ–µ
UserRepo.get_users(user_ids=[1, 2, 3])
# —á–µ–º —Ç–∞–∫–æ–µ
query = select(User).where(User.id.in_([1, 2, 3]))
async with Session() as session:
    result = session.execute(query)
    data = await result.scalars().all()
```

**Interface** - —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π –æ–∂–∏–¥–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö —Ç–∏–ø–æ–≤.
–ü—Ä–∏–º–µ—Ä [interfaces.py](project/components/chat/interfaces.py).
–ò–∑–±–∞–≤–ª—è–µ—Ç –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞,
—á—Ç–æ–±—ã –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏–Ω–≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**Adapter** - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü—Ä–∏–º–µ—Ä [llm.py](project/infrastructure/adapters/llm.py).
–ß—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π,
–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ–º —Å –Ω–∏–º–∏ —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥.
–ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é, –Ω–∞—Ö–æ–¥—è—â—É—é—Å—è –∑–∞ —Ñ–∞—Å–∞–¥–æ–º.

**DIContainer** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑.
–ü—Ä–∏–º–µ—Ä [container.py](project/container.py).
–ó–Ω–∞–µ—Ç –∫–æ–º—É, –∫–∞–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω—É–∂–Ω—ã –∏ –æ—Ç–∫—É–¥–∞ –∏—Ö –≤–∑—è—Ç—å.
–ò–∑–±–∞–≤–ª—è–µ—Ç –Ω–∞—Å –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥—É–º–∞—Ç—å, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤ –æ–¥–Ω–æ–π **—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –∏–∑–º–µ–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π, —Ç.–µ. –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–æ–º–µ–Ω–∞,
–ª—É—á—à–µ —Å–æ–∑–¥–∞–π—Ç–µ –µ—â–µ –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —ç—Ç–æ–≥–æ.

## –õ–∏–Ω—Ç–µ—Ä —Å–ª–æ–µ–≤
–ï—Å—Ç—å –ª–∏–Ω—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ñ–∏–≥–µ [layers.toml](../../layers.toml).
–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 
```bash
layers-linter project
```

---

# –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã

–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —ç—Ç–æ —Ç–æ–ø –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω, –¥–∞–ª—É—é—â–∏–π –ø—Ä–æ–≥—Ä–∞–º–º—É –∫—Ä–∞–π–Ω–µ –ø–ª–æ—Ö–æ–π (TODO: –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ—á–µ–º—É).

–í–º–µ—Å—Ç–æ –Ω–∏—Ö —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã —Å –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤ –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞)

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ —á–∞—Å—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —ç—Ç–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–Ω—É–∫—Ü–∏—é —Å –∫–µ—à–æ–º.
–¢–∞–º –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç, –≤—ã –≤—ã–∑—ã–≤–∞–µ—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –∏ –ø–æ–ª—É—á–∞–µ—Ç–µ –æ–±—ä–µ–∫—Ç, —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–æ–∂–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–æ 
–º–æ–º–µ–Ω—Ç–∞ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

```python
from functools import cache
from langchain_openai import ChatOpenAI
from project.settings import Settings

@cache
def client():
    return ChatOpenAI(
        api_key=Settings().LLM_API_KEY.get_secret_value(),
    )

async def llm_logic():
    result = await client().ainvoke()
```

–ï—Å–ª–∏ –≤ —Ç–µ—Å—Ç–∞—Ö –Ω—É–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —Ç–æ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
`LazyInit` –∏–∑ [structures.py](project/libs/structures.py), –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ 
–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

–ü—Ä–∏–º–µ—Ä —Ç–∞–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Å–∞ [Settings](project/settings.py), –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ 
–æ–∫—Ä—É–∂–µ–Ω–∏—è, –∞ –≤ —Ç–µ—Å—Ç–∞—Ö –º—ã —Ö–æ—Ç–∏–º –∑–∞–º–µ–Ω—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
class MyServiceClass:
    def __init__(self, param):
        self.param = param
        
    def do_something(self):
        return self.param

MyService = LazyInit(MyServiceClass, kwargs_func=lambda: {"param": Settings().PARAM})

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
result = MyService().do_something()

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
my_service = MyService()  # ‚ùå –ü–õ–û–•–û
my_service.do_something()

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–µ–Ω–∏–≤–æ.
class MyClass:
    def __init__(self):
        self.adapter = GitLabAdapter()
        
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –í—ã–∑–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –ª–µ–Ω–∏–≤–æ
def myfunc():
    x = MyService().do_something()
```

---

# –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤

- ruff check --fix (–ª–∏–Ω—Ç–µ—Ä)
- ruff format (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- di-linter (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—ä–µ–∫—Ü–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- la-linter (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Å–ª–æ–µ–≤)
- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ requirements.txt —á–µ—Ä–µ–∑ UV

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å layers-linter
–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [layers-linter](https://github.com/pavelmaksimov/layers-linter)
–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü –º–µ–∂–¥—É —Å–ª–æ—è–º–∏.

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ [layers.toml](layers.toml), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã:
- –°–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (dicontainer, usecases, services, repo, orm, adapters –∏ —Ç.–¥.)
- –ú–æ–¥—É–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ –∫–∞–∂–¥—ã–π —Å–ª–æ–π
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Å–ª–æ—è–º–∏ (–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—è)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ —Å–ª–æ—è—Ö

–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
layers-linter project
```

–õ–∏–Ω—Ç–µ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–º–ø–æ—Ä—Ç—ã –≤ –∫–æ–¥–µ –∏ –≤—ã—è–≤–ª—è–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü:
1. –ö–æ–≥–¥–∞ –º–æ–¥—É–ª—å –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–ª–æ—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å –∏–∑ —Å–ª–æ—è, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –µ–º—É –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∑–∞–≤–∏—Å–µ—Ç—å
2. –ö–æ–≥–¥–∞ –º–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω—é—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä—É—é –¥–ª—è –Ω–µ–≥–æ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —á–∏—Å—Ç–æ—Ç—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Å–ª–æ—è–º–∏.

---

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ï—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫ —Å–æ–±–∏—Ä–∞–µ–º—ã—Ö –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ —á–µ—Ä–µ–∑ Prometheus.
–ú–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —É –∫–æ–ª–ª–µ–≥ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –¥–µ–≤–æ–ø—Å–æ–≤.
–¢–∞–∫–∂–µ –Ω–∞ —ç—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ –¥–∞—à–±–æ—Ä–¥–∞—Ö –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ —Ç–µ–ª–µ–≥—Ä–∞–º

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –∫–æ–¥–∞.
–î–ª—è Telegram –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ callback –µ—Å–ª–∏ —ç—Ç–æ telegram –±–æ—Ç.

## –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π –∫–æ–¥–∞

–î–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä.

–ß—Ç–æ–±—ã —ç—Ç–∏ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–º–æ–≥–ª–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤–æ–∑–Ω–∏–∫–ª–æ–≤–∞–Ω–∏—è exception, –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã
–ø–æ–¥–∞–≤–ª—è—Ç—å—Å—è exception.

```python
from llm_common.prometheus import action_tracking, action_tracking_decorator

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞
with action_tracking("data_processing") as tracker:
    # –í–∞—à –∫–æ–¥
    processed_data = process_data()
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç—Ä–µ–∫–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    tracker.size(len(processed_data))
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫ –æ—à–∏–±–∫—É
    tracker.to_fail()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
@action_tracking_decorator("myfeature_llm_call")
async def make_llm_request():
    # –í–∞—à –∫–æ–¥
    return result
```

## –ë–æ—Ç—ã Telegram

–•–æ—Ä–æ—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤.

–ü—Ä–∏–º–µ–Ω—è–π–µ—Ç—Å—è –Ω–∞ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –∫–Ω–æ–ø–æ–∫ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä—ã action_tracking –∏ action_tracking_decorator
–í –∫–∞—á–µ—Å—Ç–≤–µ –∏–º–µ–Ω–∏ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å—É—Ñ—Ñ–∏–∫—Å "_handler" action_tracking(name="menu_handler"), —ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–∞ 
–≥—Ä–∞—Ñ–∏–∫–µ —Ç–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤

## –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö action

–î–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram, —Å—É—Ñ—Ñ–∏–∫—Å "_handler"
–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–¥–∞—á, —Å—É—Ñ—Ñ–∏–∫—Å "_task"
–î–ª—è –≤—ã–∑–æ–≤–æ–≤ llm, —Å—É—Ñ—Ñ–∏–∫—Å "_llm_call"
–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ llm, —Å—É—Ñ—Ñ–∏–∫—Å "_agent"

–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è –∏–º–µ–Ω: "_"

## üìñ API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### action_tracking(name: str)
–ö–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –∏ –æ—à–∏–±–æ—á–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç—Ä–µ–∫–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### action_tracking_decorator(name: str)
–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–æ—Ä—É—Ç–∏–Ω, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `action_tracking`.

## üîç –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `genapp_`:

#### HTTP –º–µ—Ç—Ä–∏–∫–∏:
- `genapp_http_requests_total` - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `genapp_http_request_duration_sec` - –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- `genapp_http_request_size_bytes` - –†–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π:
- `genapp_action_count_total` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- `genapp_action_duration_sec` - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
- `genapp_action_size_total` - –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### Labels (—Ç–µ–≥–∏)

–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç labels:
- http_requests_total ‚Üí method, status, resource, app_type, env, app
- http_request_duration_sec ‚Üí method, status, resource, app_type, env, app
- http_request_size_bytes ‚Üí resource, status, method, direction, app_type, env, app
- action_count_total ‚Üí name, status, env, app
- action_duration_sec ‚Üí name, env, app
- action_size_total ‚Üí name, env, app

---

–ü—Ä–æ —É—Ç–∏–ª–∏—Ç—ã
- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç [fsm.py](../../project/libs/fsm.py) (–º–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π, FSM).
  TODO: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

TODO: –æ–ø–∏—Å–∞—Ç—å –¥—Ä—É–≥–∏–µ —É—Ç–∏–ª–∏—Ç—ã

---

# –ü—Ä–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

## Alembic
- Alembic –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## uvloop
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø—Ä–∏–æ–∂–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ uvloop.
–û–Ω –≥–æ—Ä–∞–∑–¥–æ –±—ã—Å—Ç—Ä–µ–µ.

## –õ–∏–Ω—Ç–µ—Ä—ã
–ø—Ä–æ –Ω–∏—Ö –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ [linters.md](linters.md)

## python-telegram-bot
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–æ–≤

## FastAPI
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API

TODO: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ –¥—Ä—É–≥–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

---

# –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ project.settings.Settings

TODO: —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ SecretStr

## –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Settings

–û–±—ä–µ–∫—Ç `Settings` –≤ —Ñ–∞–π–ª–µ `project/settings.py` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `LazyInit`
–∏ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ –∫–ª–∞—Å—Å–∞ `Settings().param_name`.

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏
–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 1. –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
`LazyInit` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –û—Ç–ª–æ–∂–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!
- –≠–∫–æ–Ω–æ–º–∏—é –ø–∞–º—è—Ç–∏
- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ `Settings.local(**kwargs)`

## ‚ùå –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù–´ - —á—Ç–æ –ù–ï –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
settings = Settings()
model_name = settings.LLM_MODEL_NAME
```

**–ü–æ—á–µ–º—É –ø–ª–æ—Ö–æ:**
- –ù–∞—Ä—É—à–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!
- –°–æ–∑–¥–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä–µ–∫—Ç
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –£—Å–ª–æ–∂–Ω—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö —Ñ—É–Ω–∫—Ü–∏–π
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
def process_data(settings=Settings()):
    return settings.MAX_TOKENS

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
def create_agent(config: SettingsValidator = Settings()):
    pass
```

**–ü–æ—á–µ–º—É –ø–ª–æ—Ö–æ:**
- –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏, –∞ –Ω–µ –≤—ã–∑–æ–≤–∞
- –ù–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã
- –î–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –º–µ–Ω–µ–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö –∫–ª–∞—Å—Å–∞
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
class MyClass:
    def __init__(self):
        self.settings = Settings()  # ‚ùå –ü–õ–û–•–û

    def process(self):
        return self.settings.MAX_TOKENS
```

**–ü–æ—á–µ–º—É –ø–ª–æ—Ö–æ:**
- –§–∏–∫—Å–∏—Ä—É–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞!
- –ü—Ä–µ–ø—è—Ç—Å—Ç–≤—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –£—Å–ª–æ–∂–Ω—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è —Ç–µ—Å—Ç–æ–≤
def some_function():
    print(Settings().MAX_TOKENS)

with Settings.local(MAX_TOKENS=1000, TEMPERATURE=0.5):
    result = some_function()
    # –í —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ some_function –∏ Settings().MAX_TOKENS –≤–µ—Ä–Ω–µ—Ç 1000
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```py
import typing as t
from enum import Enum
from pathlib import Path

from pydantic import PostgresDsn, AfterValidator, SecretStr
from pydantic_settings import BaseSettings, SettingsConfigDict

from project.libs.structures import LazyInit

__all__ = ["Settings"]


def not_empty_validator(value):
    if not value:
        error_msg = "Field cannot be empty"
        raise ValueError(error_msg)
    return value


NotEmptyStrT = t.Annotated[str, AfterValidator(not_empty_validator)]
NotEmptySecretStrT = t.Annotated[SecretStr, AfterValidator(not_empty_validator)]

MONITORING_APP_NAME = ""
API_ROOT_PATH = "/api"


class Envs(Enum):
    PROD = "PROD"  # to work at a prod stand
    LAMBDA = "LAMBDA"  # to work at a stable stand
    SANDBOX = "SANDBOX"  # to work on a test stand
    TEST = "AUTOTEST"  # for run testing
    LOCAL = "LOCAL"  # for local development


class SettingsValidator(BaseSettings):
    # Application
    ENV: Envs = Envs.PROD
    API_TOKEN: NotEmptySecretStrT
    HISTORY_WINDOW: int = 20

    # Keycloak
    KEYCLOAK_URL: str = ""
    KEYCLOAK_CLIENT_ID: str = ""
    KEYCLOAK_USERNAME: str = ""
    KEYCLOAK_PASSWORD: SecretStr | None = None

    # Auth service
    BOT_AUTH_SERVICE_URL: str = ""

    # Database
    SQLALCHEMY_DATABASE_DSN: PostgresDsn  # Example: postgresql+psycopg2://user:password@localhost:5432/database
    DATABASE_PRE_PING: t.Annotated[bool, "Checks and creates connection if closed before requesting"] = False

    # Telegram
    TELEGRAM_BOT_TOKEN: NotEmptySecretStrT
    TELEGRAM_BASE_URL: str = ""
    TELEGRAM_FILE_BASE_URL: str = ""

    # Redis
    REDIS_HOST: str = ""
    REDIS_PORT: str = ""
    REDIS_DB: str = ""

    # LLM
    LLM_MODEL: NotEmptyStrT
    LLM_API_KEY: NotEmptySecretStrT
    LLM_MIDDLE_PROXY_URL: str = ""
    LLM_TEMPERATURE: float = 0.3
    LLM_MAX_TOKENS: int = 8192
    LLM_TIMEOUT: float | None = None

    # Logging settings
    WRITE_LOGS_TO_FILE: bool = True
    LOG_LEVEL: str = "INFO"
    FASTAPI_LOG_LEVEL: str = "INFO"
    TELEGRAM_LOG_LEVEL: str = "INFO"
    HTTP_REQUESTS_LOG_LEVEL: str = "ERROR"
    SQLALCHEMY_LOG_LEVEL: str = "ERROR"
    REDIS_LOG_LEVEL: str = "ERROR"
    FLASK_LOG_LEVEL: str = "ERROR"

    # Loading local settings for development environment.
    model_config = SettingsConfigDict(env_file=Path(__file__).parent.parent / ".env", extra="allow")

    def is_local(self):
        return self.ENV == Envs.LOCAL

    def is_production(self):
        return self.ENV == Envs.PROD

    def is_testable_stand(self):
        return self.ENV in (Envs.LAMBDA, Envs.SANDBOX)

    def is_any_stand(self):
        return self.ENV in (Envs.PROD, Envs.LAMBDA, Envs.SANDBOX)


Settings = LazyInit(SettingsValidator)

```

---

–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ª–µ–≥—Ä–∞–º–∞ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ.

–ù–µ –Ω—É–∂–Ω–æ –ø–æ–¥–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä processing_errors –¥–æ–ª–∂–µ–Ω –µ–≥–æ 
–ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –∏ –æ–Ω —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –º–µ—Å—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫, —è–≤–ª—è—è—Å—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –º–µ—Å—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, 
—á—Ç–æ–± –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ –≤ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ.

{–û–±—ä—è—Å–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞ –∏–∑ project/infrastructure/utils/telegram.py}

–ü–æ—Ä—è–¥–æ–∫ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –≤–∞–∂–µ–Ω!

```python
@check_auth
@timeout_with_retry
@processing_errors
@action_tracking_decorator("start_handler")
async def start_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    message = f"–ü—Ä–∏–≤–µ—Ç {user_id}! –≠—Ç–æ –ø—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º!"

    await update.message.reply_text(message)
```

---

# –î–æ–º–µ–Ω–Ω–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–∏–ø—ã.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã str, int –∏ —Ç.–ø.
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–∏–ø—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ —Å –∏–º–µ–Ω–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
–ö–æ–¥ —Å —Ç–∞–∫–∏–º–∏ —Ç–∏–ø–∞–º–∏ –ª—É—á—à–µ —á–∏—Ç–∞–µ—Ç—Å—è, —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –∏ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç —Ä–∏—Å–∫ –ø–µ—Ä–µ–ø—É—Ç–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã.

–ü—Ä–∏–º–µ—Ä:
```python
import typing as t

UserIdT = t.NewType("UserIdT", t.Annotated[int, "User ID"])
```

–¢–∞–∫–∏–µ —Ç–∏–ø—ã —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –≤ [datatypes.py](../../project/datatypes.py)

–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞–∫–∏—Ö —Ç–∏–ø–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ:
```py
import typing as t

UserIdT = t.NewType("UserIdT", t.Annotated[int, "User ID"])
AnswerT = t.NewType("AnswerT", t.Annotated[str, "–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"])
QuestionT = t.NewType("QuestionT", t.Annotated[str, "–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–≤–æ–∞—Ç–µ–ª—è"])

```
